Possible Reasons for State Loss

displayReportBuilderResults() hides/restores messages and may remove or re-render parts of the DOM

In your ChatResearchApp:

if (mode === 'report' && this.appState.getCurrentResearchData()) {
    this.displayReportBuilderResults();
} else {
    this._restoreChatMessages();
}


displayReportBuilderResults() removes existing chat messages (or hides them), and re-renders report UI. If the source-selection UI or the “selected sources” data is only captured in the DOM (not in appState), toggling might discard them.

clearConversation() resets selectedSources and other state

clearConversation() {
    ... 
    this.selectedSources = [];
    this.currentResearchData = null;
    this.pendingAction = null;
}


If toggling modes inadvertently triggers clearConversation(), state will be lost.

AppState doesn’t persist selectedSources across mode changes

The AppState stores selectedSources, but nothing in the UI toggle logic ensures that selections persist. The UI toggle might re-render fresh cards based on currentResearchData.sources, ignoring previously toggled selections.

UI re-rendering function doesn’t re-sync checkbox states

In SourceCard, the checkbox’s checked initial state is pulled from appState.isSourceSelected(source.id). If the appState.selectedSources wasn’t populated or re-synced before render, checkboxes will appear reset. Similarly, updateSelectionStates() is only called in some transitions (or manually), so toggling a mode might skip re-sync.

Dual state in SourceCard’s this.selectedSources vs. appState.selectedSources

SourceCard tracks its own this.selectedSources set and invokes appState.addSelectedSource/removeSelectedSource. If these fall out of sync (for example, on tab toggle), the UI could reflect the local SourceCard set, ignoring appState.

_restoreChatMessages() hides or removes UI containers without re-rendering selection UI

When going back from report mode to chat, you call _restoreChatMessages() and remove .report-builder-interface. If the selection checkboxes/UI were part of those removed elements and not re-rendered, you'd lose visible selection (though internal state may remain).

✅ What to Check / Fix First

After toggling to “report”, inspect appState.selectedSources in console to see if data remains. If yes, it’s a UI rendering issue.

Ensure that when rendering the report builder UI, you reuse or re-render the selections UI using getSelectedSources() rather than re-initializing it blank.

Remove or guard against calls to clearConversation() on mode toggle — ensure it only fires when explicitly clearing chat.

Remove the dual-bookkeeping in SourceCard.selectedSources — rely exclusively on appState for the source selection truth.

In displayReportBuilderResults(), before creating the new UI, call something like SourceCard.updateSelectionStates(appState.getSelectedSources().map(s => s.id)) to sync UI with state.